<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬ Â· Mac Hangul Conversion Tool</title>
<meta name="description" content="ë§¥(NFD)ì—ì„œ ì˜¨ í•œê¸€ì„ NFCë¡œ ì•ˆì „ ë³€í™˜. URL/Latin1 ê¹¨ì§ ìë™ ë³´ì •, í´ë¦½ë³´ë“œ ë³µì‚¬, ì½”ë“œí¬ì¸íŠ¸ ì¸ìŠ¤í™í„°, íŒŒì¼ ë“œë˜ê·¸&ë“œë¡­, PWA ì˜¤í”„ë¼ì¸ ì§€ì›.">
<link rel="canonical" href="https://example.com/mac-hangul-conversion-tool">
<meta name="robots" content="index,follow">
<meta name="theme-color" content="#0c0f18">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬ Â· Mac Hangul Conversion Tool">
<meta property="og:description" content="ë§¥(NFD)ì—ì„œ ì˜¨ í•œê¸€ì„ NFCë¡œ ì•ˆì „ ë³€í™˜. URL/Latin1 ê¹¨ì§ ë³´ì •, í´ë¦½ë³´ë“œ ë³µì‚¬, íŒŒì¼/ëª¨ë°”ì¼ ì§€ì›.">
<meta property="og:url" content="https://example.com/mac-hangul-conversion-tool">
<meta property="og:locale" content="ko_KR">
<meta property="og:locale:alternate" content="en_US">

<!-- Twitter -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬ Â· Mac Hangul Conversion Tool">
<meta name="twitter:description" content="ë§¥(NFD)ì—ì„œ ì˜¨ í•œê¸€ì„ NFCë¡œ ì•ˆì „ ë³€í™˜. URL/Latin1 ê¹¨ì§ ë³´ì •, í´ë¦½ë³´ë“œ ë³µì‚¬, íŒŒì¼/ëª¨ë°”ì¼ ì§€ì›.">

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="favicon.ico">

<style>
  :root{
    --bg:#0c0f18; --fg:#e9edf6; --muted:#a2abc2; --card:#12172a; --line:#1e2744; --accent:#5fb3ff;
    --good:#2ec27e; --warn:#ffb86c; --bad:#ff6b6b; --btn:#22335c; --btnb:#2c4173; --btnh:#2b3f70;
  }
  /* Light theme variables */
  :root.light{
    --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#f8fafc; --line:#e5e7eb; --accent:#2563eb;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444; --btn:#e5e7eb; --btnb:#d1d5db; --btnh:#dbeafe;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;line-height:1.55}
  header{padding:18px 14px;border-bottom:1px solid var(--line)}
  header .row{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1120px;margin:0 auto}
  header h1{margin:0;font-size:18px}
  header .controls{display:flex;gap:8px;flex-wrap:wrap}
  .pill{display:inline-block;background:#1b2547;border:1px solid #2b3c6f;color:#bcd3ff;border-radius:999px;padding:3px 8px;font-size:12px}
  .pill.light{background:#eef2ff;border-color:#dbeafe;color:#1e40af}
  main{max-width:1120px;margin:0 auto;padding:18px;display:grid;gap:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1000px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card h2{margin:0 0 8px 0;font-size:16px;color:var(--muted);font-weight:600}
  textarea,.mono{width:100%;min-height:220px;background:color-mix(in srgb, var(--bg) 92%, black 8%);border:1px solid var(--line);border-radius:12px;color:var(--fg);
                 padding:12px;font-size:15px;resize:vertical;line-height:1.6}
  .mono{white-space:pre-wrap;overflow:auto}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--btn);border:1px solid var(--btnb);color:var(--fg);border-radius:12px;padding:10px 14px;cursor:pointer;font-size:15px}
  button:hover{background:var(--btnh)}
  .accent{background:var(--accent);border-color:var(--accent);color:#fff}
  .hint{font-size:12.5px;color:var(--muted);margin-top:8px}
  .badge{display:inline-block;border-radius:8px;padding:2px 8px;font-size:12px;border:1px solid var(--line);background:color-mix(in srgb, var(--bg) 96%, black 4%)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .kv{display:grid;grid-template-columns:max-content 1fr;gap:8px 14px;font-size:13px}
  .kv div:nth-child(odd){color:var(--muted)}
  .drop{border:2px dashed var(--line);border-radius:12px;padding:10px;text-align:center;margin-top:10px;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center}
  .toggle{display:inline-flex;gap:6px;align-items:center;background:var(--card);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .select{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}
  /* Mobile large buttons */
  @media(max-width:640px){
    button{width:100%;padding:14px 16px;font-size:16px;border-radius:14px}
    .two{grid-template-columns:1fr}
  }
</style>

<!-- JSON-LD: WebApplication -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬",
  "alternateName": "Mac Hangul Conversion Tool",
  "url": "https://example.com/mac-hangul-conversion-tool",
  "applicationCategory": "Utility",
  "operatingSystem": "Web",
  "description": "ë§¥(NFD)ì—ì„œ ì˜¨ í•œê¸€ì„ NFCë¡œ ì•ˆì „ ë³€í™˜í•˜ëŠ” ì˜¨ë¼ì¸ ë„êµ¬. URL/Latin1 ê¹¨ì§ ìë™ ë³´ì •, í´ë¦½ë³´ë“œ ë³µì‚¬, íŒŒì¼ ë“œë˜ê·¸&ë“œë¡­, ì˜¤í”„ë¼ì¸(PWA) ì§€ì›.",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "KRW" }
}
</script>
</head>
<body>
  <header>
    <div class="row">
      <h1 id="site-title">ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬ <span class="pill" id="site-sub">Safe Â· Pro</span></h1>
      <div class="controls">
        <div class="toggle">
          <label for="lang">ğŸŒ</label>
          <select id="lang" class="select" aria-label="Language">
            <option value="ko" selected>í•œêµ­ì–´</option>
            <option value="en">English</option>
          </select>
        </div>
        <button id="theme-toggle" aria-label="Toggle theme">ğŸŒ™ Dark</button>
        <button id="install" aria-label="Install PWA" style="display:none">â¤“ ì„¤ì¹˜</button>
      </div>
    </div>
  </header>

  <main>
    <section class="grid">
      <div class="card">
        <h2 data-i18n="input_title">ì…ë ¥</h2>
        <textarea id="input" placeholder="ì—¬ê¸°ì— ë§¥ì—ì„œ ë³µì‚¬í•œ í…ìŠ¤íŠ¸(NFD/ê¹¨ì§ í¬í•¨)ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
        <div class="bar">
          <button id="btn-paste" data-i18n="paste">ë¶™ì—¬ë„£ê¸°</button>
          <button id="btn-clear" data-i18n="clear">ì§€ìš°ê¸°</button>
          <button id="btn-swap" data-i18n="swap">ì…ë ¥ â†” ì¶œë ¥ êµí™˜</button>
        </div>
        <div class="drop" id="drop" data-i18n="drop">ì—¬ê¸°ë¡œ .txt íŒŒì¼ì„ ë“œë˜ê·¸&ë“œë¡­í•˜ê±°ë‚˜ ì„ íƒ<input type="file" id="file" accept=".txt" style="display:block;margin:8px auto 0"></div>
        <div class="hint" data-i18n="auto_hint">ë³€ê²½ ì‹œ ìš°ì¸¡ ê²°ê³¼ê°€ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="card">
        <h2 data-i18n="output_title">ê²°ê³¼</h2>
        <div class="two">
          <div>
            <div class="badge" data-i18n="display_mode">í‘œì‹œìš©</div>
            <div id="output" class="mono" aria-label="ë³€í™˜ ê²°ê³¼"></div>
            <div class="bar">
              <button class="accent" id="btn-copy" data-i18n="copy_result">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
              <button id="btn-select" data-i18n="select_all">ì „ì²´ ì„ íƒ</button>
              <button id="btn-download" data-i18n="download_txt">.txt ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
          <div>
            <div class="badge" data-i18n="copy_variant">ì„ íƒ ë³€í™˜ ë³µì‚¬</div>
            <div class="bar">
              <button id="btn-copy-nfc" data-i18n="copy_nfc">NFCë¡œ ë³µì‚¬</button>
              <button id="btn-copy-nfd" data-i18n="copy_nfd">NFDë¡œ ë³µì‚¬</button>
              <button id="btn-copy-raw" data-i18n="copy_raw">ì›ë³¸ ê·¸ëŒ€ë¡œ ë³µì‚¬</button>
            </div>
            <div class="hint" data-i18n="copy_hint">â€» í™”ë©´ í‘œì‹œì™€ ë³„ê°œë¡œ, ì›í•˜ëŠ” ì •ê·œí™” í˜•íƒœë¡œ ì§ì ‘ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="hint" id="why">ê²½ë¡œ: -</div>
      </div>
    </section>

    <section class="card">
      <h2 data-i18n="mode_title">ëª¨ë“œ ë° ì˜µì…˜</h2>
      <div class="bar">
        <label class="toggle"><input type="checkbox" id="mode-safe" checked> <span data-i18n="safe_mode">ì•ˆì „ ëª¨ë“œ(ìë™ íŒë‹¨)</span></label>
        <label class="toggle"><input type="checkbox" id="opt-nfc" checked> <span>NFC</span></label>
        <label class="toggle"><input type="checkbox" id="opt-url" checked> <span>URL</span></label>
        <label class="toggle"><input type="checkbox" id="opt-latin1" checked> <span>Latin1</span></label>
        <label class="toggle"><input type="checkbox" id="opt-manual" checked> <span data-i18n="manual_fix">ìˆ˜ë™ ë³´ì •</span></label>
        <button id="btn-try-all" data-i18n="try_all">ëª¨ë“  ë°©ì‹ ì ìˆ˜ ë¹„êµ</button>
        <button id="btn-original" data-i18n="show_original">ì›ë³¸ í‘œì‹œ</button>
      </div>
      <div class="kv" id="stats"></div>
    </section>

    <section class="card">
      <h2 data-i18n="inspector_title">ì½”ë“œí¬ì¸íŠ¸ ì¸ìŠ¤í™í„°</h2>
      <div class="two">
        <div>
          <div class="badge" data-i18n="original">ì›ë³¸</div>
          <div id="ins-src" class="mono" style="min-height:140px"></div>
        </div>
        <div>
          <div class="badge" data-i18n="result">ê²°ê³¼</div>
          <div id="ins-out" class="mono" style="min-height:140px"></div>
        </div>
      </div>
      <div class="hint" data-i18n="inspector_hint">ê° ë¬¸ìì— ëŒ€í•´ U+ì½”ë“œì™€ í•œê¸€ ì—¬ë¶€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</div>
    </section>

    <div class="hint" data-i18n="privacy_note">â€» ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì „ì†¡ ì—†ìŒ)</div>
  </main>

<script>
// --- Theme Toggle (Dark/Light) ---
const root = document.documentElement;
const themeBtn = document.getElementById('theme-toggle');
function applyTheme(mode){
  if(mode==='light'){ root.classList.add('light'); themeBtn.textContent='ğŸŒš Light'; }
  else { root.classList.remove('light'); themeBtn.textContent='ğŸŒ™ Dark'; }
  localStorage.setItem('theme', mode);
}
const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
applyTheme(savedTheme);
themeBtn.addEventListener('click', ()=> applyTheme(root.classList.contains('light') ? 'dark' : 'light'));

// --- i18n (KO/EN toggle) ---
const i18n = {
  ko: {
    site_title: 'ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬', sub: 'Safe Â· Pro',
    input_title:'ì…ë ¥', paste:'ë¶™ì—¬ë„£ê¸°', clear:'ì§€ìš°ê¸°', swap:'ì…ë ¥ â†” ì¶œë ¥ êµí™˜',
    drop:'ì—¬ê¸°ë¡œ .txt íŒŒì¼ì„ ë“œë˜ê·¸&ë“œë¡­í•˜ê±°ë‚˜ ì„ íƒ', auto_hint:'ë³€ê²½ ì‹œ ìš°ì¸¡ ê²°ê³¼ê°€ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.',
    output_title:'ê²°ê³¼', display_mode:'í‘œì‹œìš©', copy_result:'ğŸ“‹ ê²°ê³¼ ë³µì‚¬', select_all:'ì „ì²´ ì„ íƒ', download_txt:'.txt ë‹¤ìš´ë¡œë“œ',
    copy_variant:'ì„ íƒ ë³€í™˜ ë³µì‚¬', copy_nfc:'NFCë¡œ ë³µì‚¬', copy_nfd:'NFDë¡œ ë³µì‚¬', copy_raw:'ì›ë³¸ ê·¸ëŒ€ë¡œ ë³µì‚¬', copy_hint:'â€» í™”ë©´ í‘œì‹œì™€ ë³„ê°œë¡œ, ì›í•˜ëŠ” ì •ê·œí™” í˜•íƒœë¡œ ì§ì ‘ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    mode_title:'ëª¨ë“œ ë° ì˜µì…˜', safe_mode:'ì•ˆì „ ëª¨ë“œ(ìë™ íŒë‹¨)', manual_fix:'ìˆ˜ë™ ë³´ì •', try_all:'ëª¨ë“  ë°©ì‹ ì ìˆ˜ ë¹„êµ', show_original:'ì›ë³¸ í‘œì‹œ',
    inspector_title:'ì½”ë“œí¬ì¸íŠ¸ ì¸ìŠ¤í™í„°', original:'ì›ë³¸', result:'ê²°ê³¼', inspector_hint:'ê° ë¬¸ìì— ëŒ€í•´ U+ì½”ë“œì™€ í•œê¸€ ì—¬ë¶€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.',
    privacy_note:'â€» ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì „ì†¡ ì—†ìŒ)',
    reason_prefix:'ê²½ë¡œ: ',
    meta_title:'ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬ Â· Mac Hangul Conversion Tool',
    meta_desc:'ë§¥(NFD)ì—ì„œ ì˜¨ í•œê¸€ì„ NFCë¡œ ì•ˆì „ ë³€í™˜. URL/Latin1 ê¹¨ì§ ìë™ ë³´ì •, í´ë¦½ë³´ë“œ ë³µì‚¬, ì½”ë“œí¬ì¸íŠ¸ ì¸ìŠ¤í™í„°, íŒŒì¼ ë“œë˜ê·¸&ë“œë¡­, PWA ì˜¤í”„ë¼ì¸ ì§€ì›.'
  },
  en: {
    site_title:'Mac Hangul Conversion Tool', sub:'Safe Â· Pro',
    input_title:'Input', paste:'Paste', clear:'Clear', swap:'Swap In/Out',
    drop:'Drag & drop or choose a .txt file here', auto_hint:'The result updates automatically when the input changes.',
    output_title:'Output', display_mode:'Display', copy_result:'ğŸ“‹ Copy Result', select_all:'Select All', download_txt:'Download .txt',
    copy_variant:'Copy with normalization', copy_nfc:'Copy as NFC', copy_nfd:'Copy as NFD', copy_raw:'Copy Raw', copy_hint:'Copy in your desired normalization independent from the display.',
    mode_title:'Mode & Options', safe_mode:'Safe mode (auto)', manual_fix:'Manual fix', try_all:'Compare all methods', show_original:'Show Original',
    inspector_title:'Codepoint Inspector', original:'Original', result:'Result', inspector_hint:'Displays U+code and Hangul flag for each character.',
    privacy_note:'All processing is done locally in your browser. No network transfer.',
    reason_prefix:'Path: ',
    meta_title:'Mac Hangul Conversion Tool Â· ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬',
    meta_desc:'Safely convert Mac (NFD) Hangul to NFC. Auto-fix URL/Latin1 mojibake, clipboard copy, codepoint inspector, drag & drop, PWA offline.'
  }
};
const langSel = document.getElementById('lang');
function applyLang(lang){
  const dict = i18n[lang] || i18n.ko;
  document.getElementById('site-title').innerHTML = dict.site_title + ' <span class="pill">'+dict.sub+'</span>';
  document.title = dict.meta_title;
  document.querySelector('meta[name="description"]').setAttribute('content', dict.meta_desc);
  document.documentElement.setAttribute('lang', lang);
  // text nodes with data-i18n
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if(dict[key]) el.textContent = dict[key];
  });
  localStorage.setItem('lang', lang);
}
applyLang(localStorage.getItem('lang') || 'ko');
langSel.value = localStorage.getItem('lang') || 'ko';
langSel.addEventListener('change', e => applyLang(e.target.value));

// --- Core conversion (Safe+Pro merged) ---
const $id = id => document.getElementById(id);
const outputEl = $id('output');
const whyEl = $id('why');
const insSrcEl = $id('ins-src');
const insOutEl = $id('ins-out');
const statsEl = $id('stats');

const NFD_JAMO = /[\u1100-\u11FF\u3130-\u318F]/;
const HANGUL_SYL = /[\uAC00-\uD7A3]/;
const MOJIBAKE_SEQ = /Ãƒ|Ã‚|Â¤|ï¿½/;
const PERCENT_ENC = /%[0-9A-Fa-f]{2}/;

function looksPureNFD(s){ return NFD_JAMO.test(s) && !HANGUL_SYL.test(s); }
function looksMojibakeLatin1(s){ return MOJIBAKE_SEQ.test(s); }
function looksPercentEncoded(s){ return PERCENT_ENC.test(s); }

function urlDecode(str){
  try{ return decodeURIComponent(str.replace(/\+/g,'%20')); }
  catch(e){ return str.replace(/%[0-9A-Fa-f]{2}/g, m=>{ try{return decodeURIComponent(m);}catch{ return m; } }); }
}
function toLatin1Bytes(str){
  const bytes = new Uint8Array(str.length);
  for(let i=0;i<str.length;i++){ bytes[i] = str.charCodeAt(i) & 0xFF; }
  return bytes;
}
function latin1ToUtf8(str){
  try{ return new TextDecoder('utf-8',{fatal:false}).decode(toLatin1Bytes(str)); }
  catch(e){ return str; }
}
const manualPairs = [
  ['Ãƒâ€','Ã„'], ['Ãƒâ€“','Ã–'], ['ÃƒÅ“','Ãœ'], ['ÃƒÂ§','Ã§'], ['ÃƒÂ±','Ã±'],
  ['ÃƒÂ¡','Ã¡'], ['ÃƒÂ©','Ã©'], ['ÃƒÂ³','Ã³'], ['ÃƒÂ¨','Ã¨'], ['ÃƒÂµ','Ãµ'],
  ['ÃƒÂ«','Ã«'], ['ÃƒÂ¬','Ã¬'], ['ÃƒÂ­','Ã­'], ['ÃƒÂª','Ãª'], ['ÃƒÂ©','Ã©']
];
function manualFix(s){
  let t = s;
  for(const [a,b] of manualPairs){ t = t.split(a).join(b); }
  return latin1ToUtf8(t);
}

function pipeline(src, opts){
  let out = src;
  if(opts.url) out = urlDecode(out);
  if(opts.latin1) out = latin1ToUtf8(out);
  if(opts.manual) out = manualFix(out);
  if(opts.nfc) out = out.normalize('NFC');
  return out;
}
function hangulCount(s){ const m = s.match(/[\u1100-\u11FF\u3130-\u318F\uAC00-\uD7A3]/g); return m ? m.length : 0; }
function codepointInfo(s){
  const arr = [];
  for(const ch of s){
    const cp = ch.codePointAt(0).toString(16).toUpperCase().padStart(4,'0');
    const isHangul = /[\uAC00-\uD7AF]/.test(ch) || /[\u1100-\u11FF]/.test(ch) || /[\u3130-\u318F]/.test(ch);
    arr.push(`${ch === '\n' ? 'â' : ch}  â€”  U+${cp}${isHangul ? ' (Hangul)' : ''}`);
  }
  return arr.join('\n');
}
function score(s){
  const h = hangulCount(s);
  const bad = (s.match(/\uFFFD/g)||[]).length;
  const len = s.trim().length;
  return h*10 - bad*2 + Math.min(len, 50)/50;
}
function bestOfAll(src){
  const variants = [];
  const combos = [
    {nfc:true, url:true, latin1:true, manual:true, label:'ëª¨ë‘ ì ìš©'},
    {nfc:true, url:false, latin1:true, manual:true, label:'URL ì œì™¸'},
    {nfc:true, url:true, latin1:false, manual:true, label:'Latin1 ì œì™¸'},
    {nfc:true, url:true, latin1:true, manual:false, label:'ìˆ˜ë™ ì œì™¸'},
    {nfc:true, url:false, latin1:false, manual:false, label:'NFCë§Œ'},
    {nfc:false, url:true, latin1:true, manual:true, label:'ì •ê·œí™” ì œì™¸'}
  ];
  for(const c of combos){
    const text = pipeline(src, c);
    variants.push({label:c.label, text, score:score(text)});
  }
  variants.sort((a,b)=>b.score-a.score);
  return variants;
}

const modeSafe = $id('mode-safe');
const optNFC = $id('opt-nfc');
const optURL = $id('opt-url');
const optLAT = $id('opt-latin1');
const optMAN = $id('opt-manual');
const inputEl = $id('input');

function render(){
  const src = inputEl.value;
  let out, reason;
  const lang = localStorage.getItem('lang') || 'ko';
  const prefix = i18n[lang].reason_prefix;

  if(modeSafe.checked){
    if(looksPureNFD(src)){ out = src.normalize('NFC'); reason='NFDâ†’NFC'; }
    else if(looksPercentEncoded(src)){ out = urlDecode(src).normalize('NFC'); reason='URLâ†’NFC'; }
    else if(looksMojibakeLatin1(src)){ out = latin1ToUtf8(src).normalize('NFC'); reason='Latin1â†’UTF-8â†’NFC'; }
    else { out = (()=>{ try{return src.normalize('NFC');}catch{return src;} })(); reason='NFC only'; }
    whyEl.textContent = prefix + reason + ' (Safe)';
  }else{
    const opts = { nfc:optNFC.checked, url:optURL.checked, latin1:optLAT.checked, manual:optMAN.checked };
    out = pipeline(src, opts);
    whyEl.textContent = prefix + 'Manual pipeline';
  }

  outputEl.textContent = out;
  statsEl.innerHTML = `
    <div>ì…ë ¥ ê¸¸ì´</div><div>${src.length.toLocaleString()}</div>
    <div>ì…ë ¥ í•œê¸€ ìˆ˜</div><div>${hangulCount(src).toLocaleString()}</div>
    <div>ì¶œë ¥ ê¸¸ì´</div><div>${out.length.toLocaleString()}</div>
    <div>ì¶œë ¥ í•œê¸€ ìˆ˜</div><div>${hangulCount(out).toLocaleString()}</div>
  `;
  insSrcEl.textContent = codepointInfo(src);
  insOutEl.textContent = codepointInfo(out);
}

document.getElementById('btn-paste').addEventListener('click', async () => {
  try{ const txt = await navigator.clipboard.readText(); inputEl.value = txt; render(); }
  catch{ alert((localStorage.getItem('lang')||'ko')==='ko'?'í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.':'Clipboard access blocked.'); }
});
document.getElementById('btn-clear').addEventListener('click', ()=>{ inputEl.value=''; render(); });
document.getElementById('btn-swap').addEventListener('click', ()=>{
  const tmp = inputEl.value; inputEl.value = outputEl.textContent || ''; outputEl.textContent = tmp; render();
});
document.getElementById('btn-copy').addEventListener('click', async ()=>{
  const text = outputEl.textContent || '';
  if(!text.trim()){ alert((localStorage.getItem('lang')||'ko')==='ko'?'ë³µì‚¬í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.':'Nothing to copy.'); return; }
  try{ await navigator.clipboard.writeText(text); alert('âœ…'); }catch{
    const sel = window.getSelection(); const range = document.createRange();
    range.selectNodeContents(outputEl); sel.removeAllRanges(); sel.addRange(range);
    const ok = document.execCommand('copy'); sel.removeAllRanges();
    alert(ok ? 'âœ…' : 'âŒ');
  }
});
document.getElementById('btn-select').addEventListener('click', ()=>{
  const sel = window.getSelection(); const range = document.createRange();
  range.selectNodeContents(outputEl); sel.removeAllRanges(); sel.addRange(range);
});
document.getElementById('btn-download').addEventListener('click', ()=>{
  const blob = new Blob([outputEl.textContent||''], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download='converted_ko.txt'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('btn-copy-nfc').addEventListener('click', async ()=>{
  const text = (outputEl.textContent||'').normalize('NFC'); if(!text){ alert(''); return; }
  await navigator.clipboard.writeText(text).then(()=>alert('âœ…')).catch(()=>alert('âŒ'));
});
document.getElementById('btn-copy-nfd').addEventListener('click', async ()=>{
  const text = (outputEl.textContent||'').normalize('NFD'); if(!text){ alert(''); return; }
  await navigator.clipboard.writeText(text).then(()=>alert('âœ…')).catch(()=>alert('âŒ'));
});
document.getElementById('btn-copy-raw').addEventListener('click', async ()=>{
  const text = inputEl.value || ''; if(!text){ alert(''); return; }
  await navigator.clipboard.writeText(text).then(()=>alert('âœ…')).catch(()=>alert('âŒ'));
});
document.getElementById('btn-original').addEventListener('click', ()=>{ outputEl.textContent = inputEl.value; render(); });
document.getElementById('btn-try-all').addEventListener('click', ()=>{
  const src = inputEl.value; const arr = bestOfAll(src);
  const msg = arr.map(x=>`â€¢ ${x.label} â€” ${x.score.toFixed(2)}`).join('\n');
  alert(msg);
});
// File input & drop
const fileInput = document.getElementById('file'); const drop = document.getElementById('drop');
fileInput.addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(!f) return; const txt = await f.text(); inputEl.value = txt; render(); });
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background='color-mix(in srgb, var(--bg) 92%, black 8%)'; }));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background=''; }));
drop.addEventListener('drop', async (e)=>{ const f = e.dataTransfer.files[0]; if(!f) return; const txt = await f.text(); inputEl.value = txt; render(); });

// Re-render on option changes
['mode-safe','opt-nfc','opt-url','opt-latin1','opt-manual'].forEach(id => document.getElementById(id).addEventListener('change', render));
document.getElementById('input').addEventListener('input', render);

// PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('install').style.display = 'inline-block';
});
document.getElementById('install').addEventListener('click', async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('install').style.display = 'none';
});

// Register service worker
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('service-worker.js'));
}

// First render
render();
</script>
</body>
</html>
