
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬ Â· Mac Hangul Conversion Tool</title>
<meta name="description" content="ë§¥(NFD) í•œê¸€ì„ NFC/NFDë¡œ ì•ˆì „ ë³€í™˜. ì…ë ¥/ì¶œë ¥ ëª¨ë‘ ë¶„ë¦¬í˜•(ìëª¨) í‘œì‹œ ëª¨ë“œ(í˜¸í™˜ ìëª¨) ì§€ì›. URL/Latin1 ê¹¨ì§ ë³´ì •, ë“œë˜ê·¸&ë“œë¡­, ì¸ìŠ¤í™í„°, AdFit, PWA.">
<link rel="manifest" href="manifest.webmanifest">
<style>
  :root{ --bg:#0c0f18; --fg:#e9edf6; --muted:#a2abc2; --card:#12172a; --line:#1e2744; --accent:#5fb3ff; --btn:#22335c; --btnb:#2c4173; --btnh:#2b3f70; }
  :root.light{ --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#f8fafc; --line:#e5e7eb; --accent:#2563eb; --btn:#e5e7eb; --btnb:#d1d5db; --btnh:#dbeafe; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;line-height:1.55}
  header{padding:18px 14px;border-bottom:1px solid var(--line)}
  header .row{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1120px;margin:0 auto}
  main{max-width:1120px;margin:0 auto;padding:14px 18px 18px;display:grid;gap:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1000px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  h2{margin:0 0 8px 0;font-size:16px;color:var(--muted);font-weight:600}
  textarea,.mono{width:100%;min-height:220px;background:color-mix(in srgb, var(--bg) 92%, black 8%);border:1px solid var(--line);border-radius:12px;color:var(--fg);
                 padding:12px;font-size:15px;resize:vertical;line-height:1.6}
  .mono{white-space:pre-wrap;overflow:auto}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--btn);border:1px solid var(--btnb);color:var(--fg);border-radius:12px;padding:10px 14px;cursor:pointer;font-size:15px}
  button:hover{background:var(--btnh)}
  .accent{background:var(--accent);border-color:var(--accent);color:#fff}
  .hint{font-size:12.5px;color:var(--muted);margin-top:8px}
  .badge{display:inline-block;border-radius:8px;padding:2px 8px;font-size:12px;border:1px solid var(--line);background:color-mix(in srgb, var(--bg) 96%, black 4%)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .kv{display:grid;grid-template-columns:max-content 1fr;gap:8px 14px;font-size:13px}
  .kv div:nth-child(odd){color:var(--muted)}
  .drop{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;border:2px dashed var(--line);border-radius:12px;
        padding:14px;text-align:center;color:var(--muted);margin-top:10px;transition:background .15s, border-color .15s}
  .drop.hover{background:color-mix(in srgb, var(--bg) 92%, black 8%);border-color:var(--accent)}
  .select{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}
  @media(max-width:640px){ button{width:100%;padding:14px 16px;font-size:16px;border-radius:14px} .two{grid-template-columns:1fr} }
  .ad-slot{display:flex;align-items:center;justify-content:center;background:color-mix(in srgb, var(--bg) 96%, black 4%);border:1px dashed var(--line);
           border-radius:12px; overflow:hidden}
  .ad-top{min-height:90px} .ad-mid{min-height:250px} .ad-bottom{min-height:90px}
  .toggle{display:inline-flex;gap:8px;align-items:center;background:color-mix(in srgb, var(--bg) 96%, black 4%);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .mirror{width:100%;min-height:120px;background:color-mix(in srgb, var(--bg) 94%, black 6%);border:1px dashed var(--line);border-radius:12px;color:var(--fg);
          padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;white-space:pre-wrap;overflow:auto}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>ë§¥ í•œê¸€ ë³€í™˜ ë„êµ¬ Â· Mac Hangul Conversion Tool (v12)</strong>
    <div class="controls">
      <select id="lang" class="select"><option value="ko" selected>í•œêµ­ì–´</option><option value="en">English</option></select>
      <button id="theme-toggle">ğŸŒ™ Dark</button>
      <button id="install" style="display:none">â¤“ ì„¤ì¹˜</button>
    </div>
  </div>
</header>

<!-- AdFit: Top -->
<div class="ad-slot ad-top" id="adfit-top">
  <ins class="kakao_ad_area" style="display:none;"
       data-ad-unit="DAN-0zM3fFSCjNcUowVG" data-ad-width="728" data-ad-height="90"></ins>
</div>

<main>
  <section class="grid">
    <div class="card">
      <h2>ì…ë ¥</h2>
      <textarea id="input" placeholder="ì—¬ê¸°ì— ë§¥ì—ì„œ ë³µì‚¬í•œ í…ìŠ¤íŠ¸(NFD/ê¹¨ì§ í¬í•¨)ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
      <div class="bar">
        <button id="btn-paste">ë¶™ì—¬ë„£ê¸°</button>
        <button id="btn-clear">ì§€ìš°ê¸°</button>
        <button id="btn-swap">ì…ë ¥ â†” ì¶œë ¥ êµí™˜</button>
        <!-- Removed NFDë³€í™˜ -->
      </div>
      <div class="hint">
        <label class="toggle"><input type="checkbox" id="view-split-input"> <span>ì…ë ¥ë„ ë¶„ë¦¬í˜•(ìëª¨)ë¡œ í‘œì‹œ</span></label>
        <button id="btn-copy-input-split" style="display:inline-block;margin-left:6px">ë³µì‚¬</button>
      </div>
      <div id="input-mirror" class="mirror" aria-label="ì…ë ¥ ë¶„ë¦¬í˜• í‘œì‹œ" style="display:none"></div>
      <div id="dropzone" class="drop" aria-label="íŒŒì¼ ë“œë˜ê·¸&ë“œë¡­ ì˜ì—­" style="margin-top:10px">
        <div>ì—¬ê¸°ë¡œ .txt íŒŒì¼ì„ ë“œë˜ê·¸&ë“œë¡­í•˜ê±°ë‚˜ ì„ íƒ</div>
        <div><button id="btn-file" class="accent">ğŸ“ íŒŒì¼ ì„ íƒ</button></div>
        <input id="file" type="file" accept=".txt,text/plain" multiple hidden>
      </div>
      <div class="hint">ë³€ê²½ ì‹œ ìš°ì¸¡ ê²°ê³¼ê°€ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
    </div>

    <div class="card">
      <h2>ê²°ê³¼</h2>
      <div class="two">
        <div>
          <div class="badge">í‘œì‹œìš©</div>
          <div id="output" class="mono" aria-label="ë³€í™˜ ê²°ê³¼"></div>
          <div class="bar">
            <button class="accent" id="btn-copy">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
            <button id="btn-select">ì „ì²´ ì„ íƒ</button>
            <button id="btn-download">.txt ë‹¤ìš´ë¡œë“œ</button>
          </div>
          <div class="hint"><label class="toggle"><input type="checkbox" id="view-split-jamo"> <span>ê²°ê³¼ë„ ë¶„ë¦¬í˜•(ìëª¨)ë¡œ í‘œì‹œ</span></label></div>
        </div>
        <div>
          <div class="badge">ì„ íƒ ë³€í™˜ ë³µì‚¬</div>
          <div class="bar">
            <button id="btn-copy-nfc">NFCë¡œ ë³µì‚¬</button>
            <button id="btn-copy-nfd">NFDë¡œ ë³µì‚¬</button>
            <button id="btn-copy-raw">ì›ë³¸ ê·¸ëŒ€ë¡œ ë³µì‚¬</button>
          </div>
          <div class="hint">â€» í™”ë©´ í‘œì‹œì™€ ë³„ê°œë¡œ ì›í•˜ëŠ” ì •ê·œí™” í˜•íƒœë¡œ ë³µì‚¬ ê°€ëŠ¥</div>
        </div>
      </div>
      <div class="hint" id="why">ê²½ë¡œ: -</div>
    </div>
  </section>

  <section class="card">
    <h2>ëª¨ë“œ ë° ì˜µì…˜</h2>
    <div class="bar">
      <label class="toggle"><input type="checkbox" id="mode-safe" checked> <span>ì•ˆì „ ëª¨ë“œ(ìë™ íŒë‹¨)</span></label>
      <label class="toggle"><input type="checkbox" id="opt-nfc" checked> <span>NFC</span></label>
      <label class="toggle"><input type="checkbox" id="opt-url" checked> <span>URL</span></label>
      <label class="toggle"><input type="checkbox" id="opt-latin1" checked> <span>Latin1</span></label>
      <label class="toggle"><input type="checkbox" id="opt-manual" checked> <span>ìˆ˜ë™ ë³´ì •</span></label>
      <button id="btn-try-all">ëª¨ë“  ë°©ì‹ ì ìˆ˜ ë¹„êµ</button>
      <button id="btn-original">ì›ë³¸ í‘œì‹œ</button>
    </div>
    <div class="kv" id="stats"></div>
  </section>

  <!-- AdFit: Middle -->
  <div class="ad-slot ad-mid" id="adfit-mid" style="margin:6px 0;">
    <ins class="kakao_ad_area" style="display:none;"
         data-ad-unit="DAN-S7YMogDaDYRgU8lO" data-ad-width="300" data-ad-height="250"></ins>
  </div>

  <section class="card">
    <h2>ì½”ë“œí¬ì¸íŠ¸ ì¸ìŠ¤í™í„°</h2>
    <div class="two">
      <div><div class="badge">ì›ë³¸</div><div id="ins-src" class="mono" style="min-height:140px"></div></div>
      <div><div class="badge">ê²°ê³¼</div><div id="ins-out" class="mono" style="min-height:140px"></div></div>
    </div>
  </section>

  <div class="hint">â€» ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì „ì†¡ ì—†ìŒ)</div>
</main>

<!-- AdFit: Bottom -->
<div class="ad-slot ad-bottom" id="adfit-bottom" style="max-width:1120px;margin:0 auto 18px;">
  <ins class="kakao_ad_area" style="display:none;"
       data-ad-unit="DAN-dG33wSNCuNHr5DKc" data-ad-width="728" data-ad-height="90"></ins>
</div>

<script>
// ---- Theme ----
const root=document.documentElement, themeBtn=document.getElementById('theme-toggle');
function applyTheme(mode){ if(mode==='light'){ root.classList.add('light'); themeBtn.textContent='ğŸŒš Light'; } else { root.classList.remove('light'); themeBtn.textContent='ğŸŒ™ Dark'; } localStorage.setItem('theme', mode); }
applyTheme(localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light':'dark'));
themeBtn.addEventListener('click', ()=> applyTheme(root.classList.contains('light') ? 'dark':'light'));

// ---- Jamo Maps (Choseong/Jungseong/Jongseong -> Compatibility Jamo) ----
const CHO = {
  0x1100:'\u3131',0x1101:'\u3132',0x1102:'\u3134',0x1103:'\u3137',0x1104:'\u3138',0x1105:'\u3139',0x1106:'\u3141',
  0x1107:'\u3142',0x1108:'\u3143',0x1109:'\u3145',0x110A:'\u3146',0x110B:'\u3147',0x110C:'\u3148',0x110D:'\u3149',
  0x110E:'\u314A',0x110F:'\u314B',0x1110:'\u314C',0x1111:'\u314D',0x1112:'\u314E'
};
const JUNG = {
  0x1161:'\u314F',0x1162:'\u3150',0x1163:'\u3151',0x1164:'\u3152',0x1165:'\u3153',0x1166:'\u3154',0x1167:'\u3155',
  0x1168:'\u3156',0x1169:'\u3157',0x116A:'\u3158',0x116B:'\u3159',0x116C:'\u315A',0x116D:'\u315B',0x116E:'\u315C',
  0x116F:'\u315D',0x1170:'\u315E',0x1171:'\u315F',0x1172:'\u3160',0x1173:'\u3161',0x1174:'\u3162',0x1175:'\u3163'
};
const JONG = {
  0x11A8:'\u3131', 0x11A9:'\u3132', 0x11AA:'\u3131\u3145', 0x11AB:'\u3134', 0x11AC:'\u3134\u3148', 0x11AD:'\u3134\u314E',
  0x11AE:'\u3137', 0x11AF:'\u3139', 0x11B0:'\u3139\u3131', 0x11B1:'\u3139\u3141', 0x11B2:'\u3139\u3142', 0x11B3:'\u3139\u3145',
  0x11B4:'\u3139\u314C', 0x11B5:'\u3139\u314D', 0x11B6:'\u3139\u314E', 0x11B7:'\u3141', 0x11B8:'\u3142', 0x11B9:'\u3142\u3145',
  0x11BA:'\u3145', 0x11BB:'\u3146', 0x11BC:'\u3147', 0x11BD:'\u3148', 0x11BE:'\u314A', 0x11BF:'\u314B', 0x11C0:'\u314C',
  0x11C1:'\u314D', 0x11C2:'\u314E'
};

function toCompatJamo(text){
  const out = [];
  for(const ch of (text||'').normalize('NFD')){
    const cp = ch.codePointAt(0);
    if(CHO[cp]) out.push(CHO[cp]);
    else if(JUNG[cp]) out.push(JUNG[cp]);
    else if(JONG[cp]) out.push(JONG[cp]);
    else out.push(ch);
  }
  return out.join('');
}

// ---- Detection helpers, pipeline, inspector ----
const NFD_JAMO=/[\u1100-\u11FF\u3130-\u318F]/, HANGUL_SYL=/[\uAC00-\uD7A3]/, MOJIBAKE_SEQ=/Ãƒ|Ã‚|Â¤|ï¿½/, PERCENT_ENC=/%[0-9A-Fa-f]{2}/;
function looksPureNFD(s){return NFD_JAMO.test(s)&&!HANGUL_SYL.test(s)} function looksMojibakeLatin1(s){return MOJIBAKE_SEQ.test(s)} function looksPercentEncoded(s){return PERCENT_ENC.test(s)}
function urlDecode(str){try{return decodeURIComponent(str.replace(/\+/g,'%20'))}catch(e){return str.replace(/%[0-9A-Fa-f]{2}/g,m=>{try{return decodeURIComponent(m)}catch{return m}})}}
function toLatin1Bytes(str){const b=new Uint8Array(str.length);for(let i=0;i<str.length;i++)b[i]=str.charCodeAt(0)&0xFF;return b}
function latin1ToUtf8(str){try{return new TextDecoder('utf-8',{fatal:false}).decode(toLatin1Bytes(str))}catch(e){return str}}
const manualPairs=[['Ãƒâ€','Ã„'],['Ãƒâ€“','Ã–'],['ÃƒÅ“','Ãœ'],['ÃƒÂ§','Ã§'],['ÃƒÂ±','Ã±'],['ÃƒÂ¡','Ã¡'],['ÃƒÂ©','Ã©'],['ÃƒÂ³','Ã³'],['ÃƒÂ¨','Ã¨'],['ÃƒÂµ','Ãµ'],['ÃƒÂ«','Ã«'],['ÃƒÂ¬','Ã¬'],['ÃƒÂ­','Ã­'],['ÃƒÂª','Ãª']];
function manualFix(s){let t=s;for(const[a,b]of manualPairs)t=t.split(a).join(b);return latin1ToUtf8(t)}
function pipeline(src,o){let out=src;if(o?.url)out=urlDecode(out);if(o?.latin1)out=latin1ToUtf8(out);if(o?.manual)out=manualFix(out);if(o?.nfc)out=out.normalize('NFC');return out}
function hangulCount(s){const m=s.match(/[\u1100-\u11FF\u3130-\u318F\uAC00-\uD7A3]/g);return m?m.length:0}
function codepointInfo(s){const a=[];for(const ch of s){const cp=ch.codePointAt(0).toString(16).toUpperCase().padStart(4,'0');const isH=/[\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F]/.test(ch);a.push(`${ch==='\n'?'â':ch}  â€”  U+${cp}${isH?' (Hangul)':''}`)}return a.join('\n')}

// ---- Elements ----
const inputEl=document.getElementById('input');
const outputEl=document.getElementById('output');
const whyEl=document.getElementById('why');
const statsEl=document.getElementById('stats');
const insSrcEl=document.getElementById('ins-src');
const insOutEl=document.getElementById('ins-out');
const viewSplitOut=document.getElementById('view-split-jamo');
const viewSplitIn=document.getElementById('view-split-input');
const inputMirror=document.getElementById('input-mirror');
const btnCopyInputSplit=document.getElementById('btn-copy-input-split');

// ---- Render ----
function render(){
  const src=inputEl.value||''; let out, reason;
  if(document.getElementById('mode-safe').checked){
    if(looksPureNFD(src)){ out=src.normalize('NFC'); reason='NFDâ†’NFC'; }
    else if(looksPercentEncoded(src)){ out=urlDecode(src).normalize('NFC'); reason='URLâ†’NFC'; }
    else if(looksMojibakeLatin1(src)){ out=latin1ToUtf8(src).normalize('NFC'); reason='Latin1â†’UTF-8â†’NFC'; }
    else { try{ out=src.normalize('NFC'); reason='NFC only'; }catch{ out=src; reason='original'; } }
  }else{
    const opts={ nfc:document.getElementById('opt-nfc').checked,
                 url:document.getElementById('opt-url').checked,
                 latin1:document.getElementById('opt-latin1').checked,
                 manual:document.getElementById('opt-manual').checked };
    out=pipeline(src,opts); reason='Manual pipeline';
  }

  // Output display mode (compatibility jamo)
  const displayText = (viewSplitOut && viewSplitOut.checked) ? toCompatJamo(src) : out;
  outputEl.textContent = displayText;

  // Input mirror display mode (compatibility jamo)
  if(viewSplitIn && viewSplitIn.checked){
    inputMirror.style.display='block';
    inputMirror.textContent = toCompatJamo(src);
    btnCopyInputSplit.disabled = false;
  }else{
    inputMirror.style.display='none';
    inputMirror.textContent = '';
    btnCopyInputSplit.disabled = true;
  }

  if(statsEl) statsEl.innerHTML=`
    <div>ì…ë ¥ ê¸¸ì´</div><div>${src.length.toLocaleString()}</div>
    <div>ì…ë ¥ í•œê¸€ ìˆ˜</div><div>${hangulCount(src).toLocaleString()}</div>
    <div>ì¶œë ¥ ê¸¸ì´</div><div>${out.length.toLocaleString()}</div>
    <div>ì¶œë ¥ í•œê¸€ ìˆ˜</div><div>${hangulCount(out).toLocaleString()}</div>`;
  insSrcEl.textContent=codepointInfo(src);
  insOutEl.textContent=codepointInfo(out);
  whyEl.textContent='ê²½ë¡œ: '+reason + (viewSplitOut && viewSplitOut.checked ? ' Â· ê²°ê³¼í‘œì‹œ: ë¶„ë¦¬í˜•(ìëª¨, í˜¸í™˜ìëª¨)' : '') + (viewSplitIn && viewSplitIn.checked ? ' Â· ì…ë ¥í‘œì‹œ: ë¶„ë¦¬í˜•(ìëª¨, í˜¸í™˜ìëª¨)' : '');
}

// ---- Wire events ----
inputEl.addEventListener('input', render);
document.getElementById('btn-paste').addEventListener('click', async (e)=>{
  try{
    const t=await navigator.clipboard.readText();
    inputEl.value=t;
    if(looksPureNFD(t)){ viewSplitIn.checked = true; }
    render();
  }catch{ alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ ë¶ˆê°€'); }
});
document.getElementById('btn-clear').addEventListener('click', ()=>{ inputEl.value=''; render(); });
document.getElementById('btn-swap').addEventListener('click', ()=>{ const tmp=inputEl.value; inputEl.value=outputEl.textContent||''; outputEl.textContent=tmp; render(); });
if(viewSplitOut) viewSplitOut.addEventListener('change', render);
if(viewSplitIn) viewSplitIn.addEventListener('change', render);

// Copy for input split view
btnCopyInputSplit.addEventListener('click', async ()=>{
  if(!(viewSplitIn && viewSplitIn.checked)) return;
  const t = toCompatJamo(inputEl.value||'');
  try{ await navigator.clipboard.writeText(t); alert('ë³µì‚¬ ì™„ë£Œ âœ…'); }catch{ alert('ë³µì‚¬ ì‹¤íŒ¨ âŒ'); }
});

document.getElementById('btn-copy').addEventListener('click', async ()=>{
  let t;
  if(viewSplitOut && viewSplitOut.checked){
    t = toCompatJamo(inputEl.value||'');
  }else{
    t = (document.getElementById('output').textContent||'');
  }
  if(!t.trim()) return alert('ë³µì‚¬í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
  try{ await navigator.clipboard.writeText(t); alert('ë³µì‚¬ ì™„ë£Œ âœ…'); }catch{ alert('ë³µì‚¬ ì‹¤íŒ¨ âŒ'); }
});

document.getElementById('btn-select').addEventListener('click', ()=>{ const sel=window.getSelection(); const range=document.createRange(); range.selectNodeContents(outputEl); sel.removeAllRanges(); sel.addRange(range); });
document.getElementById('btn-download').addEventListener('click', ()=>{
  let raw;
  if(viewSplitOut && viewSplitOut.checked){
    raw = toCompatJamo(inputEl.value||'');
  }else{
    raw = (document.getElementById('output').textContent||'');
  }
  const blob=new Blob([raw],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='converted_ko.txt'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('btn-copy-nfc').addEventListener('click', async ()=>{ const t=(inputEl.value||'').normalize('NFC'); if(!t) return; try{ await navigator.clipboard.writeText(t); alert('âœ…'); }catch{ alert('âŒ'); } });
document.getElementById('btn-copy-nfd').addEventListener('click', async ()=>{ const t=(inputEl.value||'').normalize('NFD'); if(!t) return; try{ await navigator.clipboard.writeText(t); alert('âœ…'); }catch{ alert('âŒ'); } });
document.getElementById('btn-copy-raw').addEventListener('click', async ()=>{ const t=inputEl.value||''; if(!t) return; try{ await navigator.clipboard.writeText(t); alert('âœ…'); }catch{ alert('âŒ'); } });
document.getElementById('btn-original').addEventListener('click', ()=>{ outputEl.textContent=inputEl.value; render(); });

// ---- Drag & Drop ----
const fileInput=document.getElementById('file');
const btnFile=document.getElementById('btn-file');
const dropzone=document.getElementById('dropzone');

btnFile.addEventListener('click', ()=> fileInput.click());
dropzone.addEventListener('click', (e)=>{ if(e.target!==btnFile) fileInput.click(); });

['dragenter','dragover'].forEach(ev => {
  dropzone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('hover'); });
});
['dragleave','drop'].forEach(ev => {
  dropzone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('hover'); });
});

dropzone.addEventListener('drop', async (e)=>{
  e.preventDefault(); e.stopPropagation();
  const dt = e.dataTransfer;
  let texts = [];

  if (dt?.items && dt.items.length) {
    for (const item of dt.items) {
      if (item.kind === 'file') {
        const f = item.getAsFile();
        if (f) {
          const t = await f.text().catch(()=>null);
          if (t != null) texts.push(t);
        }
      } else if (item.kind === 'string') {
        const t = await new Promise(res => item.getAsString(res));
        if (t) texts.push(t);
      }
    }
  } else if (dt?.files && dt.files.length) {
    for (const f of dt.files) {
      const t = await f.text().catch(()=>null);
      if (t != null) texts.push(t);
    }
  }

  if (!texts.length) {
    const plain = dt.getData('text/plain');
    if (plain) texts.push(plain);
  }

  if (texts.length) {
    inputEl.value = texts.join('\\n\\n---\\n\\n');
    if(looksPureNFD(inputEl.value)){ viewSplitIn.checked = true; }
    render();
  } else {
    alert('ë“œë¡­ëœ í•­ëª©ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
  }
});

fileInput.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  const chunks = await Promise.all(files.map(f=>f.text().catch(()=>'')));
  inputEl.value = chunks.join('\\n\\n---\\n\\n');
  if(looksPureNFD(inputEl.value)){ viewSplitIn.checked = true; }
  render();
  fileInput.value='';
});

['dragover','drop'].forEach(name => window.addEventListener(name, e => e.preventDefault(), false));

// ---- PWA + AdFit ----
let deferredPrompt; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('install').style.display='inline-block'; });
document.getElementById('install').addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; document.getElementById('install').style.display='none'; });
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('service-worker.js')); }

const adSlots=[document.getElementById('adfit-top'),document.getElementById('adfit-mid'),document.getElementById('adfit-bottom')].filter(Boolean);
function detachAdfitWatchers(){
  window.removeEventListener('scroll', handleAdfitViewportChange);
  window.removeEventListener('resize', handleAdfitViewportChange);
}
let adfitLoaded=false;
function requestAdfitRender(){
  if(!adSlots.length) return true;
  const adfit=window.kakaoAdFit;
  if(!adfit || typeof adfit.push!=='function') return false;
  adSlots.forEach(()=>adfit.push({}));
  return true;
}
function loadAdfit(){
  if(adfitLoaded) return;
  if(requestAdfitRender()){
    adfitLoaded=true;
    detachAdfitWatchers();
    return;
  }
  adfitLoaded=true;
  const s=document.createElement('script');
  s.async=true;
  s.type='text/javascript';
  s.src='https://t1.daumcdn.net/kas/static/ba.min.js';
  s.addEventListener('load',()=>{
    if(requestAdfitRender()){
      detachAdfitWatchers();
    }else{
      adfitLoaded=false;
    }
  },{once:true});
  s.addEventListener('error',()=>{
    adfitLoaded=false;
  },{once:true});
  (document.head||document.body||document.documentElement).appendChild(s);
}
function adSlotVisible(el){
  const rect=el.getBoundingClientRect();
  const viewHeight=window.innerHeight || document.documentElement.clientHeight || 0;
  return rect.bottom > 0 && rect.top < viewHeight;
}
function ensureAdfit(){
  if(adfitLoaded) return true;
  if(adSlots.some(adSlotVisible)){
    loadAdfit();
    return true;
  }
  return false;
}
function handleAdfitViewportChange(){
  ensureAdfit();
}
if(!adSlots.length){
  loadAdfit();
} else if(!ensureAdfit()){
  if('IntersectionObserver' in window){
    const io=new IntersectionObserver((entries)=>{
      if(entries.some(e=>e.isIntersecting)){
        loadAdfit();
        io.disconnect();
      }
    },{threshold:0.01,rootMargin:'120px'});
    adSlots.forEach(el=>io.observe(el));
  }
  window.addEventListener('scroll', handleAdfitViewportChange, {passive:true});
  window.addEventListener('resize', handleAdfitViewportChange);
  window.addEventListener('load', ()=> setTimeout(loadAdfit, 1200), {once:true});
  setTimeout(()=>{
    if(!ensureAdfit()){
      loadAdfit();
      ensureAdfit();
    }
  },4000);
}

// ---- Initial render ----
render();
</script>
</body>
</html>
