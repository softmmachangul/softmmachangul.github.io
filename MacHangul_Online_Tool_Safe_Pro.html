<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mac Hangul Online Tool â€” Safe+Pro</title>
<style>
  :root{
    --bg:#0c0f18; --fg:#e9edf6; --muted:#a2abc2; --card:#12172a; --line:#1e2744; --accent:#5fb3ff;
    --good:#2ec27e; --warn:#ffb86c; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;line-height:1.55}
  header{padding:22px 14px;text-align:center;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  header .sub{color:var(--muted);font-size:13px;margin-top:6px}
  main{max-width:1120px;margin:0 auto;padding:18px;display:grid;gap:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1000px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card h2{margin:0 0 8px 0;font-size:16px;color:var(--muted);font-weight:600}
  textarea,.mono{width:100%;min-height:220px;background:#0c1224;border:1px solid #2a355a;border-radius:12px;color:var(--fg);
                 padding:12px;font-size:15px;resize:vertical;line-height:1.6}
  .mono{white-space:pre-wrap;overflow:auto}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:#22335c;border:1px solid #2c4173;color:#e6ecff;border-radius:10px;padding:8px 12px;cursor:pointer;font-size:14px}
  button:hover{background:#2b3f70}
  .accent{background:var(--accent);border-color:var(--accent);color:#0b1020}
  .switch{display:inline-flex;align-items:center;gap:6px;margin-right:10px}
  .switch input{accent-color:var(--accent)}
  .hint{font-size:12.5px;color:var(--muted);margin-top:8px}
  .pill{display:inline-block;background:#1b2547;border:1px solid #2b3c6f;color:#bcd3ff;border-radius:999px;padding:3px 8px;margin-left:6px;font-size:12px}
  .badge{display:inline-block;border-radius:8px;padding:2px 8px;font-size:12px;border:1px solid #33406a;background:#151d36}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .kv{display:grid;grid-template-columns:max-content 1fr;gap:8px 14px;font-size:13px}
  .kv div:nth-child(odd){color:var(--muted)}
  .drop{border:2px dashed #2c3a67;border-radius:12px;padding:10px;text-align:center;margin-top:10px;color:#b8c5f2}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .small{font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Mac Hangul Online Tool <span class="pill">Safe Heuristics</span> <span class="pill">Pro Features</span></h1>
  <div class="sub">ê¸°ë³¸ì€ ì•ˆì „ ëª¨ë“œ(ìˆœìˆ˜ NFDëŠ” NFCë§Œ) Â· í•„ìš” ì‹œ ìˆ˜ë™ íŒŒì´í”„ë¼ì¸/ì§„ë‹¨/ì¸ìŠ¤í™í„° ì œê³µ</div>
</header>

<main>
  <section class="grid">
    <div class="card">
      <h2>ì…ë ¥</h2>
      <textarea id="input" placeholder="ì—¬ê¸°ì— ë§¥ì—ì„œ ë³µì‚¬í•œ í…ìŠ¤íŠ¸(NFD/ê¹¨ì§ í¬í•¨)ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
      <div class="bar">
        <button id="btn-paste">ë¶™ì—¬ë„£ê¸°</button>
        <button id="btn-clear">ì§€ìš°ê¸°</button>
        <button id="btn-swap">ì…ë ¥ â†” ì¶œë ¥ êµí™˜</button>
      </div>
      <div class="drop" id="drop">ì—¬ê¸°ë¡œ .txt íŒŒì¼ì„ ë“œë˜ê·¸&ë“œë¡­í•˜ê±°ë‚˜ ì„ íƒ<input type="file" id="file" accept=".txt" style="display:block;margin:8px auto 0"></div>
      <div class="hint">ë³€ê²½ ì‹œ ìš°ì¸¡ ê²°ê³¼ê°€ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
    </div>

    <div class="card">
      <h2>ê²°ê³¼</h2>
      <div class="two">
        <div>
          <div class="badge">í‘œì‹œìš©</div>
          <div id="output" class="mono" aria-label="ë³€í™˜ ê²°ê³¼"></div>
          <div class="bar">
            <button class="accent" id="btn-copy">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
            <button id="btn-select">ì „ì²´ ì„ íƒ</button>
            <button id="btn-download">.txt ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
        <div>
          <div class="badge">ì„ íƒ ë³€í™˜ ë³µì‚¬</div>
          <div class="bar">
            <button id="btn-copy-nfc">NFCë¡œ ë³µì‚¬</button>
            <button id="btn-copy-nfd">NFDë¡œ ë³µì‚¬</button>
            <button id="btn-copy-raw">ì›ë³¸ ê·¸ëŒ€ë¡œ ë³µì‚¬</button>
          </div>
          <div class="hint small">â€» í™”ë©´ í‘œì‹œì™€ ë³„ê°œë¡œ ì›í•˜ëŠ” ì •ê·œí™” í˜•íƒœë¡œ ë³µì‚¬ ê°€ëŠ¥</div>
        </div>
      </div>
      <div class="hint" id="why">ê²½ë¡œ: -</div>
    </div>
  </section>

  <section class="card">
    <h2>ëª¨ë“œ ë° ì˜µì…˜</h2>
    <div class="bar">
      <label class="switch"><input type="checkbox" id="mode-safe" checked> <span>ì•ˆì „ ëª¨ë“œ(ìë™ íŒë‹¨)</span></label>
      <label class="switch"><input type="checkbox" id="opt-nfc" checked> <span>NFC ì •ê·œí™”</span></label>
      <label class="switch"><input type="checkbox" id="opt-url" checked> <span>URL ë””ì½”ë”©</span></label>
      <label class="switch"><input type="checkbox" id="opt-latin1" checked> <span>Latin1â†’UTF-8</span></label>
      <label class="switch"><input type="checkbox" id="opt-manual" checked> <span>ìˆ˜ë™ ë³´ì •</span></label>
      <button id="btn-try-all">ëª¨ë“  ë°©ì‹ ì ìˆ˜ ë¹„êµ</button>
      <button id="btn-original">ì›ë³¸ í‘œì‹œ</button>
    </div>
    <div class="kv" id="stats"></div>
  </section>

  <section class="card">
    <h2>ì½”ë“œí¬ì¸íŠ¸ ì¸ìŠ¤í™í„°</h2>
    <div class="two">
      <div>
        <div class="badge">ì›ë³¸</div>
        <div id="ins-src" class="mono" style="min-height:140px"></div>
      </div>
      <div>
        <div class="badge">ê²°ê³¼</div>
        <div id="ins-out" class="mono" style="min-height:140px"></div>
      </div>
    </div>
    <div class="hint small">ê° ë¬¸ìì— ëŒ€í•´ U+ì½”ë“œì™€ í•œê¸€ ì—¬ë¶€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</div>
  </section>

  <div class="hint">â€» ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì „ì†¡ ì—†ìŒ)</div>
</main>

<script>
// ---------- Helpers ----------
const $ = s => document.querySelector(s);

// Detection
const NFD_JAMO = /[\\u1100-\\u11FF\\u3130-\\u318F]/;
const HANGUL_SYL = /[\\uAC00-\\uD7A3]/;
const MOJIBAKE_SEQ = /Ãƒ|Ã‚|Â¤|ï¿½/;
const PERCENT_ENC = /%[0-9A-Fa-f]{2}/;

function looksPureNFD(s){ return NFD_JAMO.test(s) && !HANGUL_SYL.test(s); }
function looksMojibakeLatin1(s){ return MOJIBAKE_SEQ.test(s); }
function looksPercentEncoded(s){ return PERCENT_ENC.test(s); }

// Transforms
function urlDecode(str){
  try{ return decodeURIComponent(str.replace(/\\+/g,'%20')); }
  catch(e){
    return str.replace(/%[0-9A-Fa-f]{2}/g, m=>{ try{return decodeURIComponent(m);}catch{ return m; } });
  }
}
function toLatin1Bytes(str){
  const bytes = new Uint8Array(str.length);
  for(let i=0;i<str.length;i++){ bytes[i] = str.charCodeAt(i) & 0xFF; }
  return bytes;
}
function latin1ToUtf8(str){
  try{
    const bytes = toLatin1Bytes(str);
    return new TextDecoder('utf-8',{fatal:false}).decode(bytes);
  }catch(e){ return str; }
}
const manualPairs = [
  ['Ãƒâ€','Ã„'], ['Ãƒâ€“','Ã–'], ['ÃƒÅ“','Ãœ'], ['ÃƒÂ§','Ã§'], ['ÃƒÂ±','Ã±'],
  ['ÃƒÂ¡','Ã¡'], ['ÃƒÂ©','Ã©'], ['ÃƒÂ³','Ã³'], ['ÃƒÂ¨','Ã¨'], ['ÃƒÂµ','Ãµ'],
  ['ÃƒÂ«','Ã«'], ['ÃƒÂ¬','Ã¬'], ['ÃƒÂ­','Ã­'], ['ÃƒÂª','Ãª'], ['ÃƒÂ©','Ã©']
];
function manualFix(s){
  let t = s;
  for(const [a,b] of manualPairs){ t = t.split(a).join(b); }
  return latin1ToUtf8(t);
}

// Pipelines
function pipeline(src, opts){
  let out = src;
  if(opts.url) out = urlDecode(out);
  if(opts.latin1) out = latin1ToUtf8(out);
  if(opts.manual) out = manualFix(out);
  if(opts.nfc) out = out.normalize('NFC');
  return out;
}

// Safe auto route
function safeConvert(src){
  let reason = '';
  let out = src;
  if(looksPureNFD(src)){
    out = src.normalize('NFC');
    reason = 'ìˆœìˆ˜ NFD í•œê¸€ â†’ NFCë§Œ ì ìš©';
  }else if(looksPercentEncoded(src)){
    out = urlDecode(src);
    try{ out = out.normalize('NFC'); }catch{}
    reason = 'URL ì¸ì½”ë”© íŒ¨í„´ â†’ URL ë””ì½”ë”© í›„ NFC';
  }else if(looksMojibakeLatin1(src)){
    out = latin1ToUtf8(src);
    try{ out = out.normalize('NFC'); }catch{}
    reason = 'ë¼í‹´1/CP1252 íŒ¨í„´ â†’ Latin1â†’UTF-8 í›„ NFC';
  }else{
    try{ out = src.normalize('NFC'); reason = 'ì¼ë°˜ í…ìŠ¤íŠ¸ â†’ NFCë§Œ ì ìš©'; }
    catch{ reason = 'ì •ê·œí™” ë¶ˆê°€ â†’ ì›ë³¸ ìœ ì§€'; }
  }
  return {out, reason};
}

// Scores & Inspectors
function hangulCount(s){
  const m = s.match(/[\\u1100-\\u11FF\\u3130-\\u318F\\uAC00-\\uD7A3]/g);
  return m ? m.length : 0;
}
function score(s){
  const h = hangulCount(s);
  const bad = (s.match(/\\uFFFD/g)||[]).length;
  const len = s.trim().length;
  return h*10 - bad*2 + Math.min(len, 50)/50;
}
function bestOfAll(src){
  const variants = [];
  const combos = [
    {nfc:true, url:true, latin1:true, manual:true, label:'ëª¨ë‘ ì ìš©'},
    {nfc:true, url:false, latin1:true, manual:true, label:'URL ì œì™¸'},
    {nfc:true, url:true, latin1:false, manual:true, label:'Latin1 ì œì™¸'},
    {nfc:true, url:true, latin1:true, manual:false, label:'ìˆ˜ë™ ì œì™¸'},
    {nfc:true, url:false, latin1:false, manual:false, label:'NFCë§Œ'},
    {nfc:false, url:true, latin1:true, manual:true, label:'ì •ê·œí™” ì œì™¸'},
  ];
  for(const c of combos){
    const text = pipeline(src, c);
    variants.push({label:c.label, text, score:score(text)});
  }
  variants.sort((a,b)=>b.score-a.score);
  return variants;
}
function codepointInfo(s){
  const arr = [];
  for(const ch of s){
    const cp = ch.codePointAt(0).toString(16).toUpperCase().padStart(4,'0');
    const isHangul = /[\\uAC00-\\uD7AF]/.test(ch) || /[\\u1100-\\u11FF]/.test(ch) || /[\\u3130-\\u318F]/.test(ch);
    arr.push(`${ch === '\\n' ? 'â' : ch}  â€”  U+${cp}${isHangul ? ' (Hangul)' : ''}`);
  }
  return arr.join('\\n');
}

// Elements
const inputEl = $('#input');
const outputEl = $('#output');
const statsEl  = $('#stats');
const whyEl    = $('#why');
const insSrcEl = $('#ins-src');
const insOutEl = $('#ins-out');
const modeSafe = $('#mode-safe');
const optNFC = $('#opt-nfc');
const optURL = $('#opt-url');
const optLAT = $('#opt-latin1');
const optMAN = $('#opt-manual');

// Render
function render(){
  const src = inputEl.value;
  let out, reason;
  if(modeSafe.checked){
    const r = safeConvert(src);
    out = r.out; reason = r.reason + ' (ì•ˆì „ ëª¨ë“œ)';
  }else{
    const opts = { nfc:optNFC.checked, url:optURL.checked, latin1:optLAT.checked, manual:optMAN.checked };
    out = pipeline(src, opts); reason = 'ìˆ˜ë™ íŒŒì´í”„ë¼ì¸ ì ìš©';
  }
  outputEl.textContent = out;
  // Stats
  statsEl.innerHTML = `
    <div>ì…ë ¥ ê¸¸ì´</div><div>${src.length.toLocaleString()}</div>
    <div>ì…ë ¥ í•œê¸€ ìˆ˜</div><div>${hangulCount(src).toLocaleString()}</div>
    <div>ì¶œë ¥ ê¸¸ì´</div><div>${out.length.toLocaleString()}</div>
    <div>ì¶œë ¥ í•œê¸€ ìˆ˜</div><div>${hangulCount(out).toLocaleString()}</div>
  `;
  // Why & Inspectors
  whyEl.textContent = 'ê²½ë¡œ: ' + reason;
  insSrcEl.textContent = codepointInfo(src);
  insOutEl.textContent = codepointInfo(out);
}

// Actions
$('#btn-paste').addEventListener('click', async () => {
  try{ const txt = await navigator.clipboard.readText(); inputEl.value = txt; render(); }
  catch{ alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.'); }
});
$('#btn-clear').addEventListener('click', ()=>{ inputEl.value=''; render(); });
$('#btn-swap').addEventListener('click', ()=>{
  const tmp = inputEl.value;
  inputEl.value = outputEl.textContent || '';
  outputEl.textContent = tmp;
  render();
});
$('#btn-copy').addEventListener('click', async ()=>{
  const text = outputEl.textContent || '';
  if(!text.trim()){ alert('ë³µì‚¬í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  try{ await navigator.clipboard.writeText(text); alert('ê²°ê³¼ ë³µì‚¬ ì™„ë£Œ âœ…'); }
  catch{
    const sel = window.getSelection(); const range = document.createRange();
    range.selectNodeContents(outputEl); sel.removeAllRanges(); sel.addRange(range);
    const ok = document.execCommand('copy'); sel.removeAllRanges();
    alert(ok ? 'ë³µì‚¬ ì™„ë£Œ âœ…' : 'ë³µì‚¬ ì‹¤íŒ¨ âŒ');
  }
});
$('#btn-select').addEventListener('click', ()=>{
  const sel = window.getSelection(); const range = document.createRange();
  range.selectNodeContents(outputEl); sel.removeAllRanges(); sel.addRange(range);
});
$('#btn-download').addEventListener('click', ()=>{
  const blob = new Blob([outputEl.textContent||''], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download='converted_ko.txt'; a.click(); URL.revokeObjectURL(url);
});
$('#btn-copy-nfc').addEventListener('click', async ()=>{
  const text = (outputEl.textContent||'').normalize('NFC');
  if(!text){ alert('ë³µì‚¬í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  await navigator.clipboard.writeText(text).then(()=>alert('NFCë¡œ ë³µì‚¬ ì™„ë£Œ âœ…')).catch(()=>alert('ë³µì‚¬ ì‹¤íŒ¨ âŒ'));
});
$('#btn-copy-nfd').addEventListener('click', async ()=>{
  const text = (outputEl.textContent||'').normalize('NFD');
  if(!text){ alert('ë³µì‚¬í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  await navigator.clipboard.writeText(text).then(()=>alert('NFDë¡œ ë³µì‚¬ ì™„ë£Œ âœ…')).catch(()=>alert('ë³µì‚¬ ì‹¤íŒ¨ âŒ'));
});
$('#btn-copy-raw').addEventListener('click', async ()=>{
  const text = inputEl.value || '';
  if(!text){ alert('ë³µì‚¬í•  ì›ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  await navigator.clipboard.writeText(text).then(()=>alert('ì›ë³¸ ê·¸ëŒ€ë¡œ ë³µì‚¬ ì™„ë£Œ âœ…')).catch(()=>alert('ë³µì‚¬ ì‹¤íŒ¨ âŒ'));
});
$('#btn-original').addEventListener('click', ()=>{
  outputEl.textContent = inputEl.value;
  render();
});
$('#btn-try-all').addEventListener('click', ()=>{
  const src = inputEl.value; const arr = bestOfAll(src);
  const msg = arr.map(x=>`â€¢ ${x.label} â€” ì ìˆ˜ ${x.score.toFixed(2)} / í•œê¸€ ${hangulCount(x.text)}`).join('\\n');
  alert('ëª¨ë“  ë°©ì‹ ë¹„êµ\\n\\n'+msg+'\\n\\nâ€» í˜„ì¬ í™”ë©´ì—ëŠ” ì•ˆì „ ëª¨ë“œ ë˜ëŠ” ìˆ˜ë™ íŒŒì´í”„ë¼ì¸ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.');
});
// File input & drop
const fileInput = $('#file'); const drop = $('#drop');
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text(); inputEl.value = txt; render();
});
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background='#0f1630'; }));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background=''; }));
drop.addEventListener('drop', async (e)=>{
  const f = e.dataTransfer.files[0]; if(!f) return;
  const txt = await f.text(); inputEl.value = txt; render();
});
// Options
[modeSafe,optNFC,optURL,optLAT,optMAN].forEach(el=>el.addEventListener('change', render));
// Live
$('#input').addEventListener('input', render);
// First render
render();
</script>
</body>
</html>
